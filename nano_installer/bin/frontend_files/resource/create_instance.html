<!DOCTYPE html>
<html>
<head>
    <!--Import Google Icon Font-->
    <link type="text/css" rel="stylesheet" href="css/material-icons.css"/>
    <!--Import materialize.css-->
    <link type="text/css" rel="stylesheet" href="css/materialize.min.css" media="screen,projection"/>
    <title>Create Instance</title>

    <!--Let browser know website is optimized for mobile-->
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>

</head>
<body>
<div class="container">
    <div class="section">
        <div class="row">
            <div class="col m10 push-m2" id="create-panel">
                <form id='create_form'>
                    <button hidden type="submit" id="submit_button"></button>
                    <div class="row">
                        <div class="input-field col m4">
                            <i class="material-icons prefix">create</i>
                            <input id="instance_name" type="text" class="validate" name="name" required>
                            <label for="instance_name" id="name-label"></label>
                        </div>
                    </div>
                    <div class="row">
                        <div class="input-field col m3">
                            <i class="material-icons prefix">blur_on</i>
                            <select name="pool" id="pool-options">
                            </select>
                            <label id="pool-label"></label>
                        </div>
                    </div>
                    <div class="row">
                        <div class="input-field">
                            <div class="col m2">
                                <label id="core-label"></label>
                            </div>
                            <div class="col m1">
                                <label>
                                    <input class="with-gap" name="cores" type="radio" checked value="1"/>
                                    <span>1</span>
                                </label>
                            </div>
                            <div class="col m1">
                                <label>
                                    <input class="with-gap" name="cores" type="radio" value="2"/>
                                    <span>2</span>
                                </label>
                            </div>
                            <div class="col m1">
                                <label>
                                    <input class="with-gap" name="cores" type="radio" value="4"/>
                                    <span>4</span>
                                </label>
                            </div>
                            <div class="col m1">
                                <label>
                                    <input class="with-gap" name="cores" type="radio" value="8"/>
                                    <span>8</span>
                                </label>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="input-field">
                            <div class="col m2">
                                <label id="memory-label"></label>
                            </div>
                            <div class="col m1">
                                <label>
                                    <input class="with-gap" name="memory" type="radio" value="536870912"/>
                                    <span>512M</span>
                                </label>
                            </div>
                            <div class="col m1">
                                <label>
                                    <input class="with-gap" name="memory" type="radio" checked value="1073741824"/>
                                    <span>1G</span>
                                </label>
                            </div>
                            <div class="col m1">
                                <label>
                                    <input class="with-gap" name="memory" type="radio" value="2147483648"/>
                                    <span>2G</span>
                                </label>
                            </div>
                            <div class="col m1">
                                <label>
                                    <input class="with-gap" name="memory" type="radio" value="4294967296"/>
                                    <span>4G</span>
                                </label>
                            </div>
                            <div class="col m1">
                                <label>
                                    <input class="with-gap" name="memory" type="radio" value="8589934592"/>
                                    <span>8G</span>
                                </label>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="input-field">
                            <div class="col m2">
                                <label id="version-label"></label>
                            </div>
                            <div class="col m3">
                                <select name="system-version" id="version-options" onchange="onSystemChanged()">
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="input-field">
                            <div class="col m2">
                                <label id="system-disk-label"></label>
                            </div>
                            <div class="col m1">
                                <label>
                                    <input class="with-gap" name="system_disk" type="radio" value="5368709120" checked/>
                                    <span>5G</span>
                                </label>
                            </div>
                            <div class="col m1">
                                <label>
                                    <input class="with-gap" name="system_disk" type="radio" value="10737418240"/>
                                    <span>10G</span>
                                </label>
                            </div>
                            <div class="col m1">
                                <label>
                                    <input class="with-gap" name="system_disk" type="radio" value="21474836480"/>
                                    <span>20G</span>
                                </label>
                            </div>
                        </div>
                    </div>
                    <div class="row" id="data-input">
                        <div class="input-field">
                            <div class="col m2">
                                <label id="data-disk-label"></label>
                            </div>
                            <div class="col m1">
                                <label>
                                    <input class="with-gap" name="data_disk" type="radio" value="0"/>
                                    <span>None</span>
                                </label>
                            </div>
                            <div class="col m1">
                                <label>
                                    <input class="with-gap" name="data_disk" type="radio" checked value="1073741824"/>
                                    <span>1G</span>
                                </label>
                            </div>
                            <div class="col m1">
                                <label>
                                    <input class="with-gap" name="data_disk" type="radio" value="2147483648"/>
                                    <span>2G</span>
                                </label>
                            </div>
                            <div class="col m1">
                                <label>
                                    <input class="with-gap" name="data_disk" type="radio" value="4294967296"/>
                                    <span>4G</span>
                                </label>
                            </div>
                            <div class="col m1">
                                <label>
                                    <input class="with-gap" name="data_disk" type="radio" value="8589934592"/>
                                    <span>8G</span>
                                </label>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col m2">
                            <label id="auto-start-label"></label>
                        </div>
                        <div class="switch">
                            <label id="auto-start-switch">
                            </label>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col m2">
                            <label id="system-image-label"></label>
                        </div>
                        <div class="input-field col m3">
                            <select name="from_image" id="image-options" onchange="onImageChanged()">
                                <option value="" id="blank-system-label"></option>
                            </select>
                        </div>
                    </div>
                    <div class="modal" id="confirm_modal">
                        <!--hide model -->
                        <div class="modal-content">
                            <h4>Confirm Create Instance</h4>
                            <p>Create new instance using following configures</p>
                        </div>
                        <div class="modal-footer">
                            <a href="#" class="modal-close waves-effect waves-green btn-flat">No</a>
                            <a href="#" class="modal-close waves-effect waves-green btn-flat" onclick="submitConfig()">Yes</a>
                        </div>
                    </div>

                </form>
            </div>

        </div>
    </div>
    <div class="divider"></div>
    <div class="section">
        <div class="row">
            <div class="col m2">
                <a class="waves-effect waves-light blue-grey lighten-2 btn" onclick="window.history.back()" id="back-caption"><i
                        class="material-icons left">chevron_left</i></a>
            </div>
            <div class="col m2 right" id="button">
                <button class="waves-effect waves-light blue-grey lighten-2 btn modal-trigger"
                        data-target="confirm_modal" id="create-caption">
                    <i class="material-icons right">add</i>
                </button>
            </div>
        </div>
    </div>
</div>

<!--JavaScript at end of body for optimized loading-->
<script type="text/javascript" src="js/jquery-3.3.1.min.js"></script>
<script type="text/javascript" src="js/materialize.min.js"></script>
<script type="text/javascript" src="js/nano.js"></script>
<script>
N.CreateMenuAndFooter();
var texts = N.GetTexts();
$('#back-caption').append(texts.get(N.TagBack));
$('#create-caption').prepend(texts.get(N.TagCreate));
$('.modal-footer > a:first-child').text(texts.get(N.TagCancel));
$('.modal-footer > a:last-child').text(texts.get(N.TagConfirm));

$('#name-label').text(texts.get(N.TagName));
$('#pool-label').text(texts.get(N.TagComputePool));
$('#core-label').text(texts.get(N.TagCore));
$('#memory-label').text(texts.get(N.TagMemory));
$('#system-label').text(texts.get(N.TagSystem));
$('#system-disk-label').text(texts.get(N.TagSystemDisk));
$('#system-image-label').text(texts.get(N.TagSystemImage));
$('#blank-system-label').text(texts.get(N.TagBlankSystem));
$('#data-disk-label').text(texts.get(N.TagDataDisk));
$('#auto-start-label').text(texts.get(N.TagAutoStart));

$('#auto-start-switch').append(
  $('<label>').append(texts.get(N.TagDisable)).append(
    $('<input>').attr('type', 'checkbox').attr('name', 'auto_start').attr('id', 'auto_start').prop('checked', true)
  ).append(
    $('<span>').addClass('lever')
  ).append(texts.get(N.TagEnable))
)

var versions = new Map(
  [
    ["centos7", {Name: 'CentOS 7 or Later', System: 'linux', Enable: true}],
    ["centos6", {Name: 'CentOS 6', System: 'linux', Enable: true}],
    ["win2012", {Name: 'Windows Server 2012', System: 'windows', Enable: true}],
    ["legacy", {Name: 'Legacy system', System: 'linux', Enable: false}],
    ["general", {Name: 'Other General System', System: 'linux', Enable: true}],
  ]
);

M.AutoInit();

function loadOptions(){
  $.getJSON("/compute_pools/", function(result){
    if (0 != result['error_code']) {
        M.toast({html: 'query compute pools fail:' + result['message']});
        return;
    }
    if (!result['data']){
      M.toast({html: 'no compute pool available'});
      return;
    }
    result['data'].forEach((pool) =>{
      var currentName = pool['name'];
      var option = $('<option>').attr('value', currentName).text(currentName);
      if (poolName&&poolName == currentName){
        option.prop('selected', true);
      }
      $('#pool-options').append(
        option
      )
    });
    M.FormSelect.init($('#pool-options'));

    $('#version-label').text(texts.get(N.TagSystemVersion));
    var versionOptions = $('#version-options');
    versions.forEach((info, version) =>{
      var option = $('<option>').attr('value', version).text(info.Name);
      if (!info.Enable){
        option.prop('disabled', true);
      }
      versionOptions.append(option);
    });

    M.FormSelect.init($('#version-options'));
  });
  var IMAGE_GROUP = "manager";
  $.getJSON("/disk_image_search?group=" + IMAGE_GROUP, function(result){
    if (0 != result['error_code']) {
        M.toast({html: 'query disk images fail:' + result['message']});
        return;
    }
    if (0 == result['data'].length){
        $('#image-options').attr('disabled', 'disabled');
        return;
    }
    result['data'].forEach((image) =>{
      $('#image-options').append(
        $('<option>').attr('value', image['id']).text(image['name'])
      )
    });
    M.FormSelect.init($('#image-options'));
  });
}

function initialForm(){
  loadOptions();
  M.Modal.init($('.modal'), {});
}

function finishCreate(){
  $('#create-result').text('success');
  var finishPage;
  if (originURL){
    finishPage = "instance_list.html";
  }else{
    finishPage = 'instances.html';
  }
  if (poolName){
    finishPage += "?pool=" + poolName;
  }
  if (cellName){
    finishPage += "&cell=" + cellName;
  }
  $('#button').append(
    $('<a>').attr('href', finishPage).append(
      $('<button>').addClass('waves-effect waves-light blue-grey lighten-2 btn').text(texts.get(N.TagFinish)).prepend(
        $('<i>').addClass('material-icons').text('check')
      )
    )
  );
}

var monitorInstanceID;

function checkResult(){
  $.ajax({
    url: '/guests/' + monitorInstanceID,
    method: "GET",
    dataType: "json",
    statusCode:{
      201: function(result){
        var progress = result['data']['progress'] + '%';
        $('#progress-bar').width(progress);
        $('#progress-info').text('Creating... ' + progress);
        setTimeout(checkResult, 1000);
      },
      200: function(result){
        if (0 != result['error_code']) {
          $('#create-result').text(result['message']);
          //fail
          return;
        }
        finishCreate();
      }
    }
  });
}

function monitorCreateProgress(id){
  $.ajax({
    url: '/guests/' + id,
    method: "GET",
    dataType: "json",
    statusCode:{
      201: function(result){
        var progress = result['data']['progress'] + '%';
        //in progress
        $('#create-result').append(
          $('<div>').addClass('center').append(
            $('<span>').text('Creating... ' + progress).attr('id', 'progress-info')
          )
        ).append(
          $('<div>').addClass('progress').append(
            $('<div>').addClass('determinate').width(progress).attr('id', 'progress-bar')
          )
        );
        //start interval check
        monitorInstanceID = id;
        setTimeout(checkResult, 2000);
      },
      200: function(result){
        if (0 != result['error_code']) {
          $('#create-result').text(result['message']);
          //fail
          return;
        }
        finishCreate();
      }
    }
  });
}



function createGuest(request){
  //update form
  $('#button').empty();
  $('#create-panel').empty().removeClass('m10').addClass('m6');
  var disks = new Array();
  request.disks.forEach((size) => {
    disks.push(size / ( 1 << 30));
  });
  var info = versions.get(request.system_version);
  var versionName = info.Name;

  var table = $('<table>').addClass('striped');
  table.append(
    $('<tr>').append(
      $('<td>').text(texts.get(N.TagName))
    ).append(
      $('<td>').text(request.name)
    )
  ).append(
    $('<tr>').append(
      $('<td>').text(texts.get(N.TagComputePool))
    ).append(
      $('<td>').text(request.pool)
    )
  ).append(
    $('<tr>').append(
      $('<td>').text(texts.get(N.TagCore))
    ).append(
      $('<td>').text(request.cores)
    )
  ).append(
    $('<tr>').append(
      $('<td>').text(texts.get(N.TagMemory))
    ).append(
      $('<td>').text((request.memory / ( 1 << 20 ) ) + ' MiB')
    )
  ).append(
    $('<tr>').append(
      $('<td>').text(texts.get(N.TagDisk))
    ).append(
      $('<td>').text(disks.join(' / ') + ' GiB')
    )
  ).append(
    $('<tr>').append(
      $('<td>').text(texts.get(N.TagSystemVersion))
    ).append(
      $('<td>').text(versionName)
    )
  ).append(
    $('<tr>').append(
      $('<td>').text(texts.get(N.TagSystem))
    ).append(
      $('<td>').text(request.system)
    )
  );
  if (request.from_image){
    table.append(
      $('<tr>').append(
        $('<td>').text(texts.get(N.TagImage))
      ).append(
        $('<td>').text(request.from_image)
      )
    );
  }
  if (request.auto_start){
    table.append(
      $('<tr>').append(
        $('<td>').text(texts.get(N.TagAutoStart))
      ).append(
        $('<td>').text(texts.get(N.TagEnable))
      )
    );
  }else{
    table.append(
      $('<tr>').append(
        $('<td>').text(texts.get(N.TagAutoStart))
      ).append(
        $('<td>').text(texts.get(N.TagDisable))
      )
    );
  }
  table.append(
    $('<tr>').append(
      $('<td>').text('ID')
    ).append(
      $('<td>').attr('id', 'guest-id')
    )
  ).append(
    $('<tr>').append(
      $('<td>').text(texts.get(N.TagResult))
    ).append(
      $('<td>').attr('id', 'create-result')
    )
  );
  $('#create-panel').append(table);
  M.AutoInit();

  //begin create
  $.ajax({
    url: '/guests/',
    method: "POST",
    dataType: "json",
    data: JSON.stringify(request),
    statusCode: {
      200:function(result){
        if (0 != result['error_code']) {
          $('#create-result').text(result['message']);
          return;
        }
        //success
        var instanceID = result['data']['id'];
        $('#guest-id').text(instanceID);
        finishCreate();
      },
      202:function(result){
        //accept
        if (0 != result['error_code']) {
          $('#create-result').text(result['message']);
          return;
        }
        var instanceID = result['data']['id'];
        $('#guest-id').text(instanceID);
        //further result
        monitorCreateProgress(instanceID);
      },
    }
  });
}

var selectedImage = "";
var selectedSystem = "linux";

function getCurrentSystem(){
  var currentVersion = $('#version-options').val();
  if (!versions.has(currentVersion)){
    M.toast({html: 'invalid version: ' + currentVersion});
    return
  }
  var info = versions.get(currentVersion);
  return info.System;
}


function onSystemChanged(){
  var currentSystem = getCurrentSystem();
  //linux
  if (currentSystem == selectedSystem){
    return;
  }
  selectedSystem = currentSystem;
  if ('linux' != currentSystem){
    //only linux allowed
    detachGuestOptions();
    return;
  }

  var currentImage = $('#image-options').val();
  if (currentImage){
    attachGuestOptions();
  }else{
    detachGuestOptions();
  }
}

function onImageChanged(){
  var currentSystem = getCurrentSystem();
  if ('linux' != currentSystem){
    //only linux allowed
    selectedImage = $('#image-options').val();
    return;
  }
  var currentImage = $('#image-options').val();
  if (currentImage != selectedImage){
    if ("" == currentImage && "" !=selectedImage){
      detachGuestOptions();
    }else if ("" != currentImage && "" ==selectedImage){
      attachGuestOptions();
    }
    selectedImage = currentImage;
  }
}

function attachGuestOptions(){
  var modules = $("<div>").addClass('row').attr('id', 'module-input').append(
    $('<div>').addClass('input-field').append(
      $('<div>').addClass('col m2').append(
        $('<label>').text(texts.get(N.TagInstalledModule))
      )
    ).append(
      $('<div>').addClass('col m2').append(
        $('<label>').append(
          $('<input>').attr('type', 'checkbox').attr('name', 'installed_modules').attr('value', 'qemu').addClass('filled-in')
        ).append(
          $('<span>').text('QEMU')
        )
      )
    ).append(
      $('<div>').addClass('col m2').append(
        $('<label>').append(
          $('<input>').attr('type', 'checkbox').attr('name', 'installed_modules').attr('onchange', 'onCIModuleChanged()')
          .attr('id', 'module-cloud-init').attr('value', 'cloud-init').addClass('filled-in')
        ).append(
          $('<span>').text('Cloud-Init')
        )
      )
    )
  );
  $("#confirm_modal").before(modules);
}

function detachGuestOptions(){
  $('#module-input').remove();
  detachCIOptions();
}

function onCIModuleChanged(){
  if ($('#module-cloud-init').is(':checked')){
    attachCIOptions();
  }else{
    detachCIOptions();
  }
}

function attachCIOptions(){
  var ci = $("<div>").addClass('row').attr('id', 'ci-input').append(
    $('<div>').addClass('input-field').append(
      $('<div>').addClass('col m2').append(
        $('<label>').text('Cloud-Init')
      )
    ).append(
      $('<div>').addClass('col m3').append(
        $('<label>').attr('for', 'auth-user').text('Admin Name')
      ).append(
        $('<input>').attr('placeholder', 'root').attr('type', 'text').attr('id', 'auth-user')
      ).append(
        $('<label>').attr('for', 'auth-secret').text('Admin Password')
      ).append(
        $('<input>').attr('placeholder', 'leave blank to generate').attr('type', 'password').attr('id', 'auth-secret')
      ).append(
        $('<label>').attr('for', 'data-path').text('Data Path')
      ).append(
        $('<input>').attr('disabled', 'disabled').attr('type', 'text').attr('id', 'data-path').attr('value', '/opt/data')
      )
    )
  );
  $("#confirm_modal").before(ci);
}

function detachCIOptions(){
  $('#ci-input').remove();
}

function submitConfig() {
    if (!$('#create_form')[0].checkValidity()) {
        $('#submit_button').click();
        return
    }
    var request = new Object();
    request.name = $('#instance_name').val();
    request.owner = 'admin';
    request.group = 'manager';
    request.pool = $('#pool-options').val();
    request.cores = Number($('input[name=cores]:checked').val());
    request.memory = Number($('input[name=memory]:checked').val());
    var currentVersion = $('#version-options').val();
    if (!versions.has(currentVersion)){
      M.toast({html: 'invalid version: ' + currentVersion});
      return
    }
    request.system_version = currentVersion

    var info = versions.get(currentVersion);
    request.system = info.System;
    request.disks = new Array();
    request.disks.push(Number($('input[name=system_disk]:checked').val()));
    var sourceImage = $('#image-options').val();
    if ('' != sourceImage){
      request.from_image = sourceImage;
      request.modules = new Array();
      $('input[name=installed_modules]:checked').each(function(){
        request.modules.push($(this).val());
      });
      if ($('#module-cloud-init').is(':checked')){
        //Cloud-init enabled
        var ciConfig = new Object();
        ciConfig.admin_name = $('#auth-user').val();
        ciConfig.admin_secret = $('#auth-secret').val();
        ciConfig.data_path = $('#data-path').val();
        request.cloud_init = ciConfig;
      }
    }
    var dataDisk = Number($('input[name=data_disk]:checked').val());
    if (0 != dataDisk){
      request.disks.push(dataDisk);
    }
    if ($('#auto_start').prop("checked")){
      request.auto_start = true;
    }else{
      request.auto_start = false;
    }
    createGuest(request);
}

var originURL, poolName, cellName;

function parseQueryString(){
  var url = window.location.search;
  var queryParams = new Map();
  var queryString = url.substring( url.indexOf('?') + 1 );
  if (0 === queryString.length){
    return queryParams;
  }
  var values = queryString.split("&");
  values.forEach((value) => {
    var p = value.split('=');
    queryParams.set(p[0], p[1]);
  });
  return queryParams;
}

$(function(){
  var params = parseQueryString();
  if (params.has('origin')){
    originURL = params.get('origin');
  }
  if (params.has('pool')){
    poolName = params.get('pool');
  }
  if (params.has('cell')){
    cellName = params.get('cell');
  }

  initialForm();
});


</script>
</body>
</html>
