<!DOCTYPE html>
<html>
<head>
    <!--Import Google Icon Font-->
    <link type="text/css" rel="stylesheet" href="css/material-icons.css"/>
    <!--Import materialize.css-->
    <link type="text/css" rel="stylesheet" href="css/materialize.min.css" media="screen,projection"/>
    <title>Modify Compute Pool</title>

    <!--Let browser know website is optimized for mobile-->
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>

</head>

<body>

<nav class="blue-grey ">
    <div class="container">
        <div class="nav-wrapper">
            <a href="#" class="brand-logo">Nano</a>
            <ul id="nav-mobile" class="right">
                <li class="hide-on-small-only"><a href="dashboard.html"><i class="material-icons left">multiline_chart</i>Dashboard</a></li>
                <li class="hide-on-small-only"><a href="compute_pools.html"><i class="material-icons left">blur_on</i>Resource Pool</a></li>
                <li class="hide-on-small-only"><a href="storages.html"><i class="material-icons left">storage</i>Storage</a></li>
                <li class="hide-on-small-only"><a href="instances.html"><i class="material-icons left">cloud</i>Instances</a></li>
                <li class="hide-on-small-only"><a href="images.html"><i class="material-icons left">content_copy</i>Images</a></li>
                <li class="hide-on-small-only"><a href="medias.html"><i class="material-icons left">album</i>Medias</a></li>
                <li class="hide-on-small-only"><a href="#"><i class="material-icons left">people</i>Users</a></li>
                <li class="hide-on-med-and-up"><a href="#"><i class="material-icons right">menu</i>Menu</a></li>
            </ul>

        </div>
    </div>
</nav>
<div class="container">
  <div class="section">
    <div class="row">
      <div class="col m6 push-m2" id="main-panel">
        <div class="row">
          <div class="input-field col m6">
            <input type="text" id="pool-name" readonly>
            <label for="pool-name">Pool Name</label>
          </div>
        </div>
        <div class="row">
          <div class="input-field col m6">
              <select name="storage" id="pool-storage">
              </select>
              <label>Storage</label>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="divider"></div>
  <div class="section">
      <div class="row">
          <div class="col m2">
              <a class="waves-effect waves-light blue-grey lighten-2 btn" onclick="window.history.back()"><i
                      class="material-icons left">chevron_left</i>Back</a>
          </div>
          <div class="col m2 right" id="button">
              <button class="waves-effect waves-light blue-grey lighten-2 btn" onclick="modifyPool()">Modify
                  <i class="material-icons right">create</i>
              </button>
          </div>
      </div>
  </div>
</div>
<footer class="page-footer  blue-grey darken-3">
    <div class="container">
        <!-- <div class="col s6 m2">
          <h4>Help</h4>
        </div> -->
    </div>
    <div class="footer-copyright">
        <div class="container">
            Â© 2018 Copyright Project Nano. All rights reserved.
        </div>
    </div>
</footer>

<!--JavaScript at end of body for optimized loading-->
<script type="text/javascript" src="js/jquery-3.3.1.min.js"></script>
<script type="text/javascript" src="js/materialize.min.js"></script>
<script>
M.AutoInit();

var poolName;

function parseQueryString(){
  var url = window.location.search;
  var queryParams = new Map();
  var queryString = url.substring( url.indexOf('?') + 1 );
  if (0 === queryString.length){
    return queryParams;
  }
  var values = queryString.split("&");
  values.forEach((value) => {
    var p = value.split('=');
    queryParams.set(p[0], p[1]);
  });
  return queryParams;
}

function loadPoolConfig(){
  $.getJSON(
    "/compute_pools/" + poolName,
    function(result){
      if (0 != result['error_code']) {
          M.toast({html: 'get compute pool info fail:' + result['message']});
          return;
      }
      $('#pool-name').val(poolName);
      var pool = result['data'];
      var currentStorage = pool['storage'];
      $.getJSON(
        "/storage_pools/",
        function(result){
          if (0 != result['error_code']) {
              M.toast({html: 'query storage pool fail:' + result['message']});
              return;
          }
          var storages = result['data'];
          if (!storages){
            $('#pool-storage').append(
              $('<option>').attr('value', "").text("default (using local storage)")
            );
            return;
          }
          var storageOptions = $('#pool-storage');
          if ('' == currentStorage){
            storageOptions.append(
              $('<option>').attr('value', "").text("local storage").attr('selected', 'selected')
            );
          }else{
            storageOptions.append(
              $('<option>').attr('value', "").text("local storage")
            );
          }

          storages.forEach((storage)=>{
            var option = $('<option>').attr('value', storage['name']).text(storage['name'] + ' (' + storage['type'] +')')
            if (storage['name'] == currentStorage){
              option.attr('selected', 'selected');
            }
            storageOptions.append(option);
          });
          M.FormSelect.init(storageOptions);
          M.updateTextFields();
        });
    });
}

function modifyPool(){
  var poolName = $('#pool-name').val();
  var poolStorage = $('#pool-storage').val();
  if (!poolName){
    M.toast({html: "please input pool name"});
    return;
  }

  var request = new Object();
  request.storage = poolStorage;
  if ('' == poolStorage){
    poolStorage = "local storage";
  }

  $('#button').empty();
  $('#main-panel').empty();

  var table = $('<table>').addClass('striped');
  table.append(
    $('<tr>').append(
      $('<td>').text('Pool')
    ).append(
      $('<td>').text(poolName)
    )
  ).append(
    $('<tr>').append(
      $('<td>').text('Storage')
    ).append(
      $('<td>').text(poolStorage)
    )
  ).append(
    $('<tr>').append(
      $('<td>').text('Result')
    ).append(
      $('<td>').attr('id', 'request-result')
    )
  );
  $('#main-panel').append(table);

  $.ajax({
    url: '/compute_pools/'+ poolName,
    method: "PUT",
    dataType: "json",
    data: JSON.stringify(request),
    success: function (result) {
      if (0 != result['error_code']) {
        $('#request-result').text(result['message']);
        return;
      }
      $('#request-result').text('success');
      $('#button').append(
        $('<a>').attr('href', 'compute_pools.html').append(
          $('<button>').addClass('waves-effect waves-light blue-grey lighten-2 btn').text('Finish').prepend(
            $('<i>').addClass('material-icons').text('check')
          )
        )
      );
    },
    error: function (jqXHR, status, error) {
      M.toast({html: 'request modify compute pool fail: ' + error, outDuration: 600});
    }
  });

}

$(function(){
  var params = parseQueryString();
  if (!params.has('pool')){
    M.toast({html: 'must specify pool name'})
    return;
  }
  poolName = params.get('pool');
  loadPoolConfig();
});


</script>
</body>
</html>
