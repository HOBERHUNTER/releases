<!DOCTYPE html>
<html>
  <head>
    <!--Import Google Icon Font-->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <!--Import materialize.css-->
    <link type="text/css" rel="stylesheet" href="css/materialize.min.css"  media="screen,projection"/>
    <title>Monitor Instance Status</title>

    <!--Let browser know website is optimized for mobile-->
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <style>
    nav.clean{
        background: none;
        box-shadow: none;
    }

    .breadcrumb:before {
        color: rgba(0,0,0,0.7);
    }

    .breadcrumb, .breadcrumb:last-child {
       color: rgba(0,0,0,1);
    }
    </style>

  </head>

  <body>

    <nav class="blue-grey ">
      <div class="container">
        <div class="nav-wrapper">
          <a href="#" class="brand-logo">Nano</a>
            <ul id="nav-mobile" class="right">
              <li class="hide-on-small-only"><a href="dashboard.html">Dashboard</a></li>
              <li class="hide-on-small-only"><a href="compute_pools.html">Compute Pool</a></li>
              <li class="hide-on-small-only"><a href="instances.html">Instances</a></li>
              <li class="hide-on-small-only"><a href="images.html">Images</a></li>
              <li class="hide-on-small-only"><a href="medias.html">Medias</a></li>
              <li class="hide-on-small-only"><a href="users.html">Users</a></li>
              <li class="hide-on-small-only"><a href="#"><i class="material-icons right">list</i></a></li>
            </ul>

        </div>
      </div>
    </nav>
  <div class="container">
    <div class="section">
      <nav class="clean">
         <div class="nav-wrapper">
           <div class="col s12" id="breadcrumb-path">
             <a href="dashboard.html" class="breadcrumb">Zone</a>
             <a href="pool_status.html" class="breadcrumb">Compute pools</a>
            </div>
        </div>
      </nav>
      <div class="divider"></div>
    </div>
    <div class="section">
      <div class="row">
        <div class="col m6 s12">
          <div class="card small">
            <div class="card-content">
              <span class="card-title" id="instance-name"><i class="material-icons blue-grey-text darken-2">cloud_queue</i>manager.admin.guest1</span>
              <table class="striped">
                <tbody>
                  <tr>
                    <td>Cores</td>
                    <td id="instance-cores"></td>
                    <td>Internal address</td>
                    <td id="instance-internal"></td>
                  </tr>
                  <tr>
                    <td>Memory</td>
                    <td id="instance-memory"></td>
                    <td>External address</td>
                    <td id="instance-external"></td>
                  </tr>
                  <tr>
                    <td>Disk</td>
                    <td id="instance-disk"></td>
                    <td></td>
                    <td id="instance-icons">
                      <i class="material-icons green-text darken-2 tooltipped" data-position="top" data-tooltip="running">play_arrow</i>
                      <i class="material-icons light-blue-text tooltipped" data-position="top" data-tooltip="autostart">all_inclusive</i>
                      <i class="material-icons blue-grey-text tooltipped" data-position="top" data-tooltip="media attached">album</i>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="card-action" id="instance-actions">
              <a href="#" class="blue-grey-text tooltipped" data-position="top" data-tooltip="Monitor"><i class="material-icons">desktop_windows</i></a>
              <a href="#" class="blue-grey-text tooltipped" data-position="top" data-tooltip="Modify"><i class="material-icons">build</i></a>
              <a href="#" class="blue-grey-text tooltipped" data-position="top" data-tooltip="Stop"><i class="material-icons">power_settings_new</i></a>
              <a href="#" class="blue-grey-text tooltipped" data-position="top" data-tooltip="Force Stop"><i class="material-icons">power</i></a>
              <a href="#" class="blue-grey-text tooltipped" data-position="top" data-tooltip="Reboot"><i class="material-icons">rotate_right</i></a>
              <a href="#" class="blue-grey-text tooltipped" data-position="top" data-tooltip="Force Reboot"><i class="material-icons">refresh</i></a>
            </div>
          </div>
        </div>
        <div class="col m3 s6">
          <div class="card small">
            <div class="card-content">
              <span class="card-title"><i class="material-icons blue-grey-text">memory</i>Core Usage</span>
              <div>
                <canvas id="cpu_canvas" height="250px"></canvas>
              </div>
            </div>
          </div>
        </div>
        <div class="col m3 s6">
          <div class="card small">
            <div class="card-content">
              <span class="card-title"><i class="material-icons blue-grey-text">sd_card</i>Memory Usage</span>
              <div>
                <canvas id="memory_canvas" height="250px"></canvas>
              </div>
            </div>
          </div>
        </div>

      </div>
      <div class="row">
        <div class="col m4 s6">
          <div class="card small">
            <div class="card-content">
              <span class="card-title"><i class="material-icons blue-grey-text">storage</i>Disk Usage</span>
              <div>
                <canvas id="disk_canvas" height="160px"></canvas>
              </div>
            </div>
          </div>
        </div>

        <div class="col m8 s12">
          <div class="card small">
            <div class="card-content">
              <span class="card-title"><i class="material-icons blue-grey-text">show_chart</i></span>
              <div>
                <canvas id="io_canvas" height="80px"></canvas>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="row">
      </div>
    </div>
  </div>
  <footer class="page-footer  blue-grey darken-3">
    <div class="container">
        <!-- <div class="col s6 m2">
          <h4>Help</h4>
        </div> -->
    </div>
    <div class="footer-copyright">
      <div class="container">
      Â© 2018 Copyright Project Nano. All rights reserved.
      </div>
    </div>
  </footer>

  <!--JavaScript at end of body for optimized loading-->
  <script type="text/javascript" src="js/materialize.min.js"></script>
  <script type="text/javascript" src="js/jquery-3.3.1.min.js"></script>
  <script type="text/javascript" src="js/Chart.bundle.min.js"></script>
  <script>
    M.AutoInit();
    var poolName;
    var cellName;
    var instanceID;
    function parseQueryString(){
      var url = window.location.search;
      var queryString = url.substring( url.indexOf('?') + 1 );
      if (0 === queryString.length){
        M.toast({html: 'no query string available', outDuration: 1500});
        return false;
      }
      var values = queryString.split("&");
      var params = new Map();
      values.forEach((value) => {
        var p = value.split('=');
        params.set(p[0], p[1]);
      });
      if (0 == params.length){
        M.toast({html: 'invalid query string', outDuration: 1500});
        return false;
      }
      if (!params.has('pool')){
        M.toast({html: 'Must specify pool name', outDuration: 1500});
        return false;
      }
      poolName = params.get('pool');
      if (params.has('cell')){
        cellName = params.get('cell');
      }
      if (!params.has('instance')){
        M.toast({html: 'Must specify instance', outDuration: 1500});
        return false;
      }
      instanceID = params.get('instance');
      return true;
    }

    var diskChart = new Chart( $("#disk_canvas"), {
      type: "doughnut",
      data: {
        labels: ["available", "used"],
        datasets: [
          {
            backgroundColor: ['#bbdefb', '#2196f3'],
          }
        ],
      },
      options: {
        cutoutPercentage: 70,
        legend: {
          display: false,
        }
      }
    });
    //cpu canvas
    var cpuChart = new Chart($("#cpu_canvas"), {
        type: "line",
        data: {
          labels: ["10", "8", "6", "4", "2", "0"],
          datasets: [
            {
              label: "cores usage",
              fill: "start",
              backgroundColor: '#c8e6c9',
            }
          ]
        },
        options: {
          legend: {
            display: false,
          },
          scales: {
            xAxes: [{
              display: true,
              scaleLabel: {
                display: true,
                labelString: 'Past Seconds'
              }
            }]
          }
        }
    });
    //memory canvas
    var memoryChart = new Chart( $("#memory_canvas"), {
        type: "line",
        data: {
          labels: ["10", "8", "6", "4", "2", "0"],
          datasets: [
            {
              label: "memory usage(GB)",
              fill: "start",
              backgroundColor: '#bbdefb',
            }
          ]
        },
        options: {
          legend: {
            display: false,
          },
          scales: {
            xAxes: [{
              display: true,
              scaleLabel: {
                display: true,
                labelString: 'Past Seconds'
              }
            }]
          }
        }
    });

    //io
    var ioChart = new Chart( $("#io_canvas"), {
        type: "bar",
        data: {
          labels: ["16", "14", "12", "10", "8", "6", "4", "2", "0"],
          datasets: [
            {
              label: "read",
              backgroundColor: '#90caf9',
            },
            {
              label: "written",
              backgroundColor: '#b0bec5',
            },
            {
              label: "received",
              backgroundColor: '#b39ddb',
            },
            {
              label: "sent",
              backgroundColor: '#9fa8da',
            },
          ]
        },
        options: {
          legend: {
            display: false,
          },
          scales: {
            xAxes: [{
              display: true,
              scaleLabel: {
                display: true,
                labelString: 'Past Seconds'
              }
            }],
            yAxes: [{
              display: true,
              scaleLabel: {
                display: true,
                labelString: 'MBytes/s'
              }
            }]
          }
        }
    });
    function initialCharts(){
      diskChart.data.datasets[0].data = [0, 0];
      for(var i = 0; i < 6;i++){
        cpuChart.data.datasets[0].data.push(0);
      }
      cpuChart.options.scales.yAxes[0].ticks = {
          min: 0,
          max: 100,
          stepSize: 20
      };
      for(var i = 0; i < 6;i++){
        memoryChart.data.datasets[0].data.push(0);
      }
      memoryChart.options.scales.yAxes[0].ticks = {
          min: 0,
          max: 100,
          stepSize: 20
      };

      for(var i = 0; i < 9;i++){
        ioChart.data.datasets.forEach((dataset) => {
          dataset.data.push(0);
        });
      }
      ioChart.options.scales.yAxes[0].ticks = {
          min: 0,
          max: 10,
          stepSize: 2
      };
      diskChart.update();
      cpuChart.update();
      memoryChart.update();
      ioChart.update();
    }

    var running, autostart, mediaAttached;
    function updateDashboard(){
      $.getJSON("/instances/" + instanceID, function(result){
        if (0 != result['error_code']) {
            M.toast({html: 'update dashboard fail:' + result['message']});
            return;
        }
        //success
        var status = result['data'];
        $('#instance-name').text(status['name']).prepend($('<i>').addClass('material-icons blue-grey-text darken-2').text('cloud_queue'));
        $('#instance-cores').text(status['cores']);

        if (running != status['running']){
          running = status['running'];
          //change
          $('#instance-icons').empty();
          $('#instance-actions').empty();
          if (running){
            $('#instance-icons').prepend(
              $('<i>').addClass('material-icons green-text darken-2 tooltipped').attr('data-position', 'top').attr('data-tooltip', 'running').text('play_arrow')
            );
            $('#instance-actions').append(
              $('<a>').addClass('blue-grey-text tooltipped').attr('data-position', 'top').attr('data-tooltip', 'Monitor').attr('href', '#').prepend(
                $('<i>').addClass('material-icons').text('desktop_windows')
              )
            ).append(
              $('<a>').addClass('blue-grey-text tooltipped').attr('data-position', 'top').attr('data-tooltip', 'Modify').attr('href', '#').prepend(
                $('<i>').addClass('material-icons').text('build')
              )
            ).append(
              $('<a>').addClass('blue-grey-text tooltipped').attr('data-position', 'top').attr('data-tooltip', 'Stop').attr('href', '#').prepend(
                $('<i>').addClass('material-icons').text('power_settings_new')
              )
            ).append(
              $('<a>').addClass('blue-grey-text tooltipped').attr('data-position', 'top').attr('data-tooltip', 'Force Stop').attr('href', '#').prepend(
                $('<i>').addClass('material-icons').text('power')
              )
            ).append(
              $('<a>').addClass('blue-grey-text tooltipped').attr('data-position', 'top').attr('data-tooltip', 'Reboot').attr('href', '#').prepend(
                $('<i>').addClass('material-icons').text('rotate_right')
              )
            ).append(
              $('<a>').addClass('blue-grey-text tooltipped').attr('data-position', 'top').attr('data-tooltip', 'Force Reboot').attr('href', '#').prepend(
                $('<i>').addClass('material-icons').text('refresh')
              )
            );
          }else{
            $('#instance-icons').prepend(
              $('<i>').addClass('material-icons red-text darken-2 tooltipped').attr('data-position', 'top').attr('data-tooltip', 'stopped').text('stop')
            );
            $('#instance-actions').append(
              $('<a>').addClass('blue-grey-text tooltipped').attr('data-position', 'top').attr('data-tooltip', 'Modify').attr('href', '#').prepend(
                $('<i>').addClass('material-icons').text('build')
              )
            ).append(
              $('<a>').addClass('blue-grey-text tooltipped').attr('data-position', 'top').attr('data-tooltip', 'Start').attr('href', '#').prepend(
                $('<i>').addClass('material-icons').text('play_arrow')
              )
            ).append(
              $('<a>').addClass('blue-grey-text tooltipped').attr('data-position', 'top').attr('data-tooltip', 'Start with Media').attr('href', '#').prepend(
                $('<i>').addClass('material-icons').text('play_circle_outline')
              )
            ).append(
              $('<a>').addClass('blue-grey-text tooltipped').attr('data-position', 'top').attr('data-tooltip', 'Delete').attr('href', '#').prepend(
                $('<i>').addClass('material-icons').text('delete')
              )
            ).append(
              $('<a>').addClass('blue-grey-text tooltipped').attr('data-position', 'top').attr('data-tooltip', 'Build Disk Image').attr('href', '#').prepend(
                $('<i>').addClass('material-icons').text('cloud_upload')
              )
            );
          }
        }
        if (autostart != status['auto_start']){
          autostart = status['auto_start'];
          if (autostart){
            $('#instance-icons').append(
              $('<i>').addClass('material-icons light-blue-text tooltipped').attr('data-position', 'top').attr('data-tooltip', 'autostart').text('all_inclusive').attr('id', 'autostart-icon')
            );
          }else{
            $('i#autostart-icon').remove();
          }
        }
        if (mediaAttached != status['media_attached']){
          mediaAttached = status['media_attached'];
          if (mediaAttached){
            $('#instance-icons').append(
              $('<i>').addClass('material-icons blue-grey-text tooltipped').attr('data-position', 'top').attr('data-tooltip', 'media attached').text('album').attr('id', 'media-icon')
            );
          }else{
            $('i#media-icon').remove();
          }
        }
        //Address
        if (status['internal']){
          var internal = status['internal'];
          if (internal['network_address']){
            $('#instance-internal').text(internal['network_address']);
          }
        }
        if (status['external']){
          var external = status['external'];
          if (external['network_address']){
            $('#instance-external').text(external['network_address']);
          }
        }

        var gib = 1 << 30;
        var availableDisk = Math.floor(status['disk_available'] * 100 / gib) / 100;
        var usedDisk = Math.floor((status['total_disk'] - status['disk_available']) * 100 / gib) / 100;
        diskChart.data.datasets[0].data = [availableDisk, usedDisk];
        var disks = new Array();
        status['disks'].forEach((disk) => {
          disks.push(disk / gib);
        });
        $('#instance-disk').text(disks.join(' / ') + ' GiB');


        //cpu
        cpuChart.data.datasets[0].data.shift();
        cpuChart.data.datasets[0].data.push(Math.floor(status['cpu_usage'] * status['cores'])/100);
        cpuChart.options.scales.yAxes[0].ticks = {
            max: status['cores'],
            stepSize: status['cores'] / 4
        };
        var used_memory = Math.floor((status['memory'] - status['memory_available']) * 100 / gib) / 100;
        var max_memory = Math.round(status['memory']  / gib) ;
        //memory
        memoryChart.data.datasets[0].data.shift();
        memoryChart.data.datasets[0].data.push(used_memory);
        memoryChart.options.scales.yAxes[0].ticks = {
            max: max_memory,
            stepSize: max_memory / 4
        };
        var mib = 1 << 20;
        $('#instance-memory').text(status['memory']/mib + ' MiB');

        var speed = [Math.floor(status['bytes_read'] * 100 / mib) / 100, Math.floor(status['bytes_written'] * 100 / mib) / 100,
            Math.floor(status['bytes_received'] * 100 / mib) / 100, Math.floor(status['bytes_sent'] * 100 / mib) / 100 ]

        for(var i = 0; i < 4 ; i++)    {
          ioChart.data.datasets[i].data.shift();
          ioChart.data.datasets[i].data.push(speed[i]);
        }
        diskChart.update();
        cpuChart.update();
        memoryChart.update();
        ioChart.update();

        M.Tooltip.init($('.tooltipped'));
      });
    }



    if (parseQueryString()){

      $('#breadcrumb-path').append(
        $('<a>').addClass('breadcrumb').text(poolName).attr('href','cell_status.html?pool=' + poolName)
      );
      if (undefined != cellName){
        $('#breadcrumb-path').append(
          $('<a>').addClass('breadcrumb').text(cellName).attr('href','instance_status.html?pool=' + poolName + "&cell=" + cellName)
        );
      }
      $('#breadcrumb-path').append(
        $('<a>').addClass('breadcrumb').text(instanceID).attr('href','#')
      );

      initialCharts();
      updateDashboard();
      setInterval(updateDashboard, 2000);
    }
  </script>
  </body>
</html>
